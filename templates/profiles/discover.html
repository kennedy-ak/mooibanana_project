<!-- templates/profiles/discover.html -->
{% extends 'base.html' %}
{% load profile_extras %}

{% block title %}Discover - Mooibanana{% endblock %}

{% block extra_head %}
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-search"></i> Discover
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4 text-white">Discover New Students</h2>

            <!-- Bootstrap Search Form with Collapsible Interface -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="fas fa-search me-2"></i> Search Profiles
                        {% if is_searching %}
                            <span class="badge bg-primary ms-2">Active</span>
                        {% endif %}
                    </h5>
                    <!-- Hamburger Button -->
                    <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#searchFilters" aria-expanded="false" aria-controls="searchFilters" id="searchToggleBtn">
                        <i class="fas fa-bars" id="searchToggleIcon"></i>
                        <span class="ms-1 d-none d-md-inline" id="searchToggleText">Filters</span>
                    </button>
                </div>
                
                <!-- Collapsible Search Form -->
                <div class="collapse {% if is_searching %}show{% endif %}" id="searchFilters">
                    <div class="card-body">
                        <form method="get" id="searchForm">
                            <!-- First Row -->
                            <div class="row g-3 mb-3">
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.search_query }}
                                        <label for="{{ search_form.search_query.id_for_label }}">{{ search_form.search_query.label }}</label>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.study_field }}
                                        <label for="{{ search_form.study_field.id_for_label }}">{{ search_form.study_field.label }}</label>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.school_name }}
                                        <label for="{{ search_form.school_name.id_for_label }}">{{ search_form.school_name.label }}</label>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.interests }}
                                        <label for="{{ search_form.interests.id_for_label }}">{{ search_form.interests.label }}</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Second Row -->
                            <div class="row g-3 mb-3">
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.city }}
                                        <label for="{{ search_form.city.id_for_label }}">{{ search_form.city.label }}</label>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.location }}
                                        <label for="{{ search_form.location.id_for_label }}">{{ search_form.location.label }}</label>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6">
                                    <div class="form-floating">
                                        {{ search_form.max_distance }}
                                        <label for="{{ search_form.max_distance.id_for_label }}">{{ search_form.max_distance.label }}</label>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 d-flex align-items-end">
                                    <div class="btn-group w-100" role="group">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search me-1"></i> Search
                                        </button>
                                        <a href="{% url 'profiles:discover' %}" class="btn btn-outline-secondary" id="clearFiltersBtn">
                                            <i class="fas fa-times me-1"></i> Clear
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <!-- Active Filters Alert -->
                        {% if is_searching %}
                        <div class="alert alert-info border-0 mt-3">
                            <small class="mb-0">
                                <strong><i class="fas fa-filter me-1"></i>Active filters:</strong>
                                {% if search_params.search_query %}<span class="badge bg-secondary me-1">Name: "{{ search_params.search_query }}"</span>{% endif %}
                                {% if search_params.study_field %}<span class="badge bg-secondary me-1">Study: "{{ search_form.study_field.field.choices|lookup:search_params.study_field }}"</span>{% endif %}
                                {% if search_params.school_name %}<span class="badge bg-secondary me-1">School: "{{ search_params.school_name }}"</span>{% endif %}
                                {% if search_params.interests %}<span class="badge bg-secondary me-1">Interests: "{{ search_params.interests }}"</span>{% endif %}
                                {% if search_params.city %}<span class="badge bg-secondary me-1">City: "{{ search_params.city }}"</span>{% endif %}
                                {% if search_params.location %}<span class="badge bg-secondary me-1">Region: "{{ search_params.location }}"</span>{% endif %}
                                {% if search_params.max_distance %}<span class="badge bg-secondary me-1">Max Distance: {{ search_params.max_distance }}km</span>{% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Daily Quiz Widget -->
            <div class="card border-0 shadow-lg mb-4" id="dailyQuizWidget">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-brain me-2"></i>Daily Knowledge Quiz
                    </h5>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-primary me-2" id="userPoints">{{ user.points_balance }} pts</span>
                        <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#quizContent" aria-expanded="true" aria-controls="quizContent" id="quizToggleBtn">
                            <i class="fas fa-chevron-down" id="quizToggleIcon"></i>
                        </button>
                    </div>
                </div>
                <div class="collapse show" id="quizContent">
                    <div class="card-body">
                        {% csrf_token %}
                        <div id="quizInnerContent">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading quiz...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        <!-- 2x2 Grid Layout for larger screens, single column for mobile -->
        <div class="row">
            {% for profile in profiles %}
            <div class="col-12 col-lg-6 mb-4">
                <div class="card h-100 overflow-hidden profile-card">
                    <div class="row g-0 h-100">
                        <!-- Image Half - Left Side -->
                        <div class="col-6 profile-image-container">
                            {% with all_photos=profile.get_all_photos %}
                            {% if all_photos %}
                                <div id="carousel-{{ profile.id }}" class="carousel slide h-100" data-bs-ride="false" data-photo-count="1/{{ all_photos|length }}">
                                    <div class="carousel-inner h-100">
                                        {% for photo in all_photos %}
                                        <div class="carousel-item h-100 {% if forloop.first %}active{% endif %}">
                                            <img src="{{ photo.url }}" class="d-block w-100 h-100 profile-image" alt="{{ profile.user.username }}">
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% if all_photos|length > 1 %}
                                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ profile.id }}" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ profile.id }}" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                    <div class="carousel-indicators">
                                        {% for photo in all_photos %}
                                        <button type="button" data-bs-target="#carousel-{{ profile.id }}" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}"></button>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="bg-light h-100 d-flex align-items-center justify-content-center profile-placeholder">
                                    <i class="fas fa-user fa-4x text-muted"></i>
                                </div>
                            {% endif %}
                            {% endwith %}
                        </div>
                        
                        <!-- Content Half - Right Side -->
                        <div class="col-6">
                            <div class="card-body h-100 d-flex flex-column p-3">
                                <div class="profile-header mb-2">
                                    <h6 class="mb-1 fw-bold">{{ profile.user.username }}
                                        {% if profile.age %}
                                            <span class="text-muted fw-normal">, {{ profile.age }}</span>
                                        {% endif %}
                                    </h6>
                                </div>

                                <div class="profile-details flex-grow-1">
                                    {% if profile.study_field %}
                                    <p class="small mb-1 text-truncate">
                                        <i class="fas fa-graduation-cap me-1"></i>{{ profile.get_study_field_display }}
                                        {% if profile.study_year %} - Y{{ profile.study_year }}{% endif %}
                                    </p>
                                    {% endif %}

                                    {% if profile.school_name %}
                                    <p class="small mb-1 text-truncate">
                                        <i class="fas fa-university me-1"></i>{{ profile.school_name }}
                                    </p>
                                    {% endif %}

                                    {% if profile.city %}
                                    <p class="small mb-1 text-truncate">
                                        <i class="fas fa-map-marker-alt me-1"></i>{{ profile.city }}
                                        {% if profile_distances and profile.id in profile_distances %}
                                            <span class="text-primary">({{ profile_distances|lookup:profile.id }}km)</span>
                                        {% endif %}
                                    </p>
                                    {% endif %}

                                    {% if profile.bio %}
                                    <p class="text-muted small mb-2" style="font-size: 0.75rem; line-height: 1.3;">
                                        {{ profile.bio|truncatewords:12 }}
                                    </p>
                                    {% endif %}

                                    {% if profile.get_interests_list %}
                                    <div class="interests-tags mb-2">
                                        {% for interest in profile.get_interests_list|slice:":2" %}
                                            <span class="badge bg-secondary me-1" style="font-size: 0.65rem;">{{ interest }}</span>
                                        {% endfor %}
                                        {% if profile.get_interests_list|length > 2 %}
                                            <span class="text-muted" style="font-size: 0.65rem;">+{{ profile.get_interests_list|length|add:"-2" }}</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Action Button -->
                                <div class="mt-auto">
                                    <a href="{% url 'profiles:profile_detail' profile.id %}" class="btn btn-primary btn-sm w-100">
                                        <i class="fas fa-eye me-1"></i> View
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center text-white">
                <h4>No Profiles Found</h4>
                <p>There are no new profiles to discover. Come back later!</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Bootstrap Pagination -->
        {% if is_paginated %}
        <div class="row">
            <div class="col-12">
                <nav aria-label="Profile pagination" class="mt-4">
                    <ul class="pagination justify-content-center flex-wrap">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' 1 %}">
                                    <i class="fas fa-angle-double-left me-1"></i>First
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' page_obj.previous_page_number %}">
                                    <i class="fas fa-angle-left me-1"></i>Previous
                                </a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' page_obj.next_page_number %}">
                                    Next<i class="fas fa-angle-right ms-1"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' page_obj.paginator.num_pages %}">
                                    Last<i class="fas fa-angle-double-right ms-1"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Daily Quiz functionality
document.addEventListener('DOMContentLoaded', function() {
    loadDailyQuiz();
    
    function loadDailyQuiz() {
        fetch('/quiz/daily/')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('quizInnerContent').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.error}
                        </div>
                    `;
                    return;
                }
                
                if (data.already_answered) {
                    displayQuizResult(data);
                } else {
                    displayQuiz(data);
                }
            })
            .catch(error => {
                console.error('Error loading quiz:', error);
                document.getElementById('quizInnerContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load quiz. Please try again later.
                    </div>
                `;
            });
    }
    
    function displayQuiz(quizData) {
        const quizHTML = `
            <div class="quiz-question">
                <h6 class="mb-3">${quizData.question}</h6>
                <div class="quiz-meta mb-3">
                    <span class="badge bg-secondary me-2">${quizData.category}</span>
                    <span class="badge bg-info me-2">${quizData.difficulty}</span>
                    <span class="badge bg-success">${quizData.points_value} ${quizData.points_value === 1 ? 'point' : 'points'}</span>
                </div>
                <div class="quiz-choices">
                    ${quizData.choices.map(choice => `
                        <button class="btn btn-outline-primary w-100 mb-2 quiz-choice" 
                                data-choice-id="${choice.id}" 
                                data-question-id="${quizData.question_id}">
                            ${choice.text}
                        </button>
                    `).join('')}
                </div>
            </div>
        `;
        
        document.getElementById('quizInnerContent').innerHTML = quizHTML;
        
        // Add click handlers to choices
        document.querySelectorAll('.quiz-choice').forEach(button => {
            button.addEventListener('click', function() {
                submitQuizAnswer(this.dataset.questionId, this.dataset.choiceId);
            });
        });
    }
    
    function displayQuizResult(resultData) {
        const resultHTML = `
            <div class="quiz-result">
                <h6 class="mb-3">${resultData.question}</h6>
                <div class="alert ${resultData.is_correct ? 'alert-success' : 'alert-danger'} border-0">
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <i class="fas ${resultData.is_correct ? 'fa-check-circle' : 'fa-times-circle'} fa-2x"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-2">${resultData.is_correct ? '🎉 Correct!' : '❌ Incorrect'}</h5>
                            ${resultData.is_correct ? 
                                `<p class="mb-2"><strong>Congratulations!</strong> You earned <span class="badge bg-success fs-6">${resultData.points_earned} ${resultData.points_earned === 1 ? 'point' : 'points'}</span></p>
                                 <p class="mb-0"><small>Your answer: <strong>${resultData.user_choice || 'N/A'}</strong></small></p>` : 
                                `<p class="mb-2">Don't worry, keep trying! The correct answer was:</p>
                                 <p class="mb-2"><strong>✅ ${resultData.correct_choice}</strong></p>
                                 <p class="mb-0"><small>Your answer: <strong>${resultData.user_choice || 'N/A'}</strong></small></p>`
                            }
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="bg-light rounded p-3 text-center">
                            <h6 class="mb-1">${resultData.accuracy || 0}%</h6>
                            <small class="text-muted">Today's Accuracy</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light rounded p-3 text-center">
                            <h6 class="mb-1" id="currentPoints">${resultData.total_points || document.getElementById('userPoints').textContent.replace(' pts', '')}</h6>
                            <small class="text-muted">Total Points</small>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Come back tomorrow for a new question!
                    </small>
                </div>
            </div>
        `;
        
        document.getElementById('quizInnerContent').innerHTML = resultHTML;
    }
    
    function submitQuizAnswer(questionId, choiceId) {
        // Disable all choice buttons
        document.querySelectorAll('.quiz-choice').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('disabled');
        });
        
        // Get CSRF token from the meta tag first, then fall back to cookie
        let csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        if (!csrfToken) {
            csrfToken = getCookie('csrftoken');
        }

        if (!csrfToken) {
            console.error('No CSRF token found');
            document.getElementById('quizContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    CSRF token not found. Please refresh the page and try again.
                </div>
            `;
            return;
        }
        
        fetch('/quiz/submit/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                question_id: questionId,
                choice_id: choiceId
            })
        })
        .then(response => {
            console.log('Response status:', response.status); // Debug log
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('CSRF token error. Please refresh the page and try again.');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Update points display
                document.getElementById('userPoints').textContent = `${data.total_points} pts`;
                
                // Show result
                displayQuizResult({
                    question: document.querySelector('.quiz-question h6').textContent,
                    is_correct: data.is_correct,
                    points_earned: data.points_earned,
                    correct_choice: data.correct_choice,
                    user_choice: data.user_choice,
                    accuracy: data.accuracy,
                    total_points: data.total_points
                });
            } else {
                alert('Error: ' + data.error);
                // Re-enable buttons
                document.querySelectorAll('.quiz-choice').forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('disabled');
                });
            }
        })
        .catch(error => {
            console.error('Error submitting answer:', error);
            alert('Failed to submit answer: ' + error.message);
            // Re-enable buttons
            document.querySelectorAll('.quiz-choice').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('disabled');
            });
        });
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Alternative CSRF token getter
    function getCSRFToken() {
        // Try to get from cookie first
        let token = getCookie('csrftoken');
        if (token) return token;
        
        // Try to get from meta tag
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) return metaTag.getAttribute('content');
        
        // Try to get from hidden input
        const hiddenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (hiddenInput) return hiddenInput.value;
        
        return null;
    }
    
    // Handle quiz collapse/expand
    const quizToggleBtn = document.getElementById('quizToggleBtn');
    const quizToggleIcon = document.getElementById('quizToggleIcon');
    const quizContent = document.getElementById('quizContent');
    
    if (quizToggleBtn && quizContent) {
        quizContent.addEventListener('show.bs.collapse', function () {
            quizToggleIcon.classList.remove('fa-chevron-down');
            quizToggleIcon.classList.add('fa-chevron-up');
        });
        
        quizContent.addEventListener('hide.bs.collapse', function () {
            quizToggleIcon.classList.remove('fa-chevron-up');
            quizToggleIcon.classList.add('fa-chevron-down');
        });
    }
});

// Auto-submit search form when study field changes
document.addEventListener('DOMContentLoaded', function() {
    const studyField = document.getElementById('id_study_field');
    if (studyField) {
        studyField.addEventListener('change', function() {
            // Auto-submit form when study field changes
            this.form.submit();
        });
    }

    // Handle hamburger button toggle animation
    const searchToggleBtn = document.getElementById('searchToggleBtn');
    const searchToggleIcon = document.getElementById('searchToggleIcon');
    const searchToggleText = document.getElementById('searchToggleText');
    const searchFilters = document.getElementById('searchFilters');

    if (searchToggleBtn && searchFilters) {
        // Add event listener for collapse toggle
        searchFilters.addEventListener('show.bs.collapse', function () {
            searchToggleIcon.classList.remove('fa-bars');
            searchToggleIcon.classList.add('fa-times');
            searchToggleText.textContent = 'Hide';
            searchToggleBtn.setAttribute('aria-expanded', 'true');
        });

        searchFilters.addEventListener('hide.bs.collapse', function () {
            searchToggleIcon.classList.remove('fa-times');
            searchToggleIcon.classList.add('fa-bars');
            searchToggleText.textContent = 'Filters';
            searchToggleBtn.setAttribute('aria-expanded', 'false');
        });

        // Set initial state if filters are already shown
        if (searchFilters.classList.contains('show')) {
            searchToggleIcon.classList.remove('fa-bars');
            searchToggleIcon.classList.add('fa-times');
            searchToggleText.textContent = 'Hide';
            searchToggleBtn.setAttribute('aria-expanded', 'true');
        }
    }

    // Add search suggestions for interests
    const interestsInput = document.getElementById('id_interests');
    if (interestsInput) {
        const commonInterests = [
            'football', 'basketball', 'tennis', 'swimming', 'running',
            'music', 'guitar', 'piano', 'singing', 'dancing',
            'reading', 'writing', 'photography', 'art', 'painting',
            'cooking', 'traveling', 'hiking', 'cycling', 'gaming',
            'movies', 'series', 'anime', 'programming', 'technology',
            'fitness', 'yoga', 'meditation', 'volunteering', 'languages'
        ];

        // Create datalist for autocomplete
        const datalist = document.createElement('datalist');
        datalist.id = 'interests-suggestions';
        commonInterests.forEach(interest => {
            const option = document.createElement('option');
            option.value = interest;
            datalist.appendChild(option);
        });

        interestsInput.setAttribute('list', 'interests-suggestions');
        interestsInput.parentNode.appendChild(datalist);
    }

    // Clear form functionality
    const clearBtn = document.getElementById('clearFiltersBtn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Clear all form fields
            const form = document.getElementById('searchForm');
            if (form) {
                form.reset();
                // Collapse the search filters after clearing
                const searchCollapse = new bootstrap.Collapse(searchFilters, {
                    hide: true
                });
                // Redirect to discover page without parameters
                setTimeout(() => {
                    window.location.href = '{% url "profiles:discover" %}';
                }, 300);
            }
        });
    }
});

// Update photo counters when carousel slides
document.addEventListener('DOMContentLoaded', function() {
    const carousels = document.querySelectorAll('.carousel');
    
    carousels.forEach(function(carousel) {
        carousel.addEventListener('slid.bs.carousel', function(e) {
            const activeIndex = Array.from(e.target.querySelectorAll('.carousel-item')).indexOf(e.relatedTarget) + 1;
            const totalPhotos = e.target.querySelectorAll('.carousel-item').length;
            e.target.setAttribute('data-photo-count', `${activeIndex}/${totalPhotos}`);
        });
        
        // Add touch/swipe support for mobile
        let startX = 0;
        let endX = 0;
        
        carousel.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
        }, { passive: true });
        
        carousel.addEventListener('touchend', function(e) {
            endX = e.changedTouches[0].clientX;
            const diff = startX - endX;
            
            if (Math.abs(diff) > 50) { // Minimum swipe distance
                const carouselInstance = bootstrap.Carousel.getOrCreateInstance(carousel);
                if (diff > 0) {
                    carouselInstance.next(); // Swipe left = next
                } else {
                    carouselInstance.prev(); // Swipe right = previous
                }
            }
        }, { passive: true });
    });
});
</script>

<style>
/* Search Toggle Button Styles */
#searchToggleBtn {
    border-radius: 8px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#searchToggleBtn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

#searchToggleIcon {
    transition: transform 0.3s ease;
}

#searchToggleBtn[aria-expanded="true"] #searchToggleIcon {
    transform: rotate(90deg);
}

/* Mobile responsiveness for search header */
@media (max-width: 768px) {
    #searchToggleText {
        display: none !important;
    }
    
    #searchToggleBtn {
        padding: 10px 12px;
        min-width: 44px;
        min-height: 44px;
    }
    
    .card-header .card-title {
        font-size: 1.1rem;
    }
}

/* Search filters animation */
#searchFilters {
    transition: all 0.3s ease;
}

#searchFilters.collapsing {
    opacity: 0.7;
}

#searchFilters.show {
    opacity: 1;
}

/* Active filters styling */
.alert-info .badge {
    font-size: 0.75rem;
    padding: 0.35em 0.65em;
    margin: 0.1rem;
}

/* Profile Card Styles - Half Image Layout */
.profile-card {
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    min-height: 280px;
}

.profile-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
}

.profile-image-container {
    position: relative;
    height: 280px;
}

.profile-image {
    object-fit: cover;
    border-radius: 12px 0 0 12px;
}

.profile-placeholder {
    border-radius: 12px 0 0 12px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

/* Carousel controls for half-image layout */
.profile-image-container .carousel-control-prev,
.profile-image-container .carousel-control-next {
    width: 30px;
    height: 30px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    transition: opacity 0.3s ease;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
}

.profile-image-container:hover .carousel-control-prev,
.profile-image-container:hover .carousel-control-next {
    opacity: 0.8;
}

.profile-image-container .carousel-control-prev {
    left: 10px;
}

.profile-image-container .carousel-control-next {
    right: 10px;
}

.profile-image-container .carousel-control-prev-icon,
.profile-image-container .carousel-control-next-icon {
    width: 12px;
    height: 12px;
}

.profile-image-container .carousel-indicators {
    bottom: 10px;
    margin-bottom: 0;
}

.profile-image-container .carousel-indicators button {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin: 0 2px;
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.9);
}

.profile-image-container .carousel-indicators button.active {
    background: #fff;
}

/* Profile content styling */
.profile-header h6 {
    font-size: 1rem;
    color: #2c3e50;
}

.profile-details p {
    margin-bottom: 0.5rem;
    color: #6c757d;
}

.profile-details i {
    color: #007bff;
    width: 12px;
}

.interests-tags .badge {
    background-color: #6c757d !important;
    border-radius: 10px;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .profile-card {
        min-height: 200px;
    }
    
    .profile-image-container {
        height: 200px;
    }
    
    .profile-header h6 {
        font-size: 0.9rem;
    }
    
    .profile-details p,
    .profile-details .small {
        font-size: 0.75rem !important;
    }
    
    .interests-tags .badge {
        font-size: 0.6rem !important;
    }
}

/* iPad specific adjustments */
@media (min-width: 768px) and (max-width: 1024px) {
    .profile-card {
        min-height: 240px;
    }
    
    .profile-image-container {
        height: 240px;
    }
}

/* Custom styles for profile image carousel */
.carousel-control-prev:hover,
.carousel-control-next:hover {
    opacity: 0.8;
}

.carousel-control-prev-icon,
.carousel-control-next-icon {
    transition: all 0.2s ease;
}

.carousel-control-prev-icon:hover,
.carousel-control-next-icon:hover {
    transform: scale(1.1);
}

.carousel-indicators button {
    transition: all 0.2s ease;
}

.carousel-indicators button:hover {
    opacity: 0.8;
    transform: scale(1.2);
}

/* iPad and Tablet specific improvements */
@media (min-width: 768px) and (max-width: 1024px) {
    /* Search form on iPad */
    .card .row.g-3 {
        margin: 0;
    }
    
    .card .col-md-4,
    .card .col-md-3,
    .card .col-md-2 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 15px;
    }
    
    /* Profile grid adjustments for iPad */
    .col-lg-6 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 25px;
    }
    
    /* Profile cards spacing */
    .card-body .row {
        align-items: center;
    }
    
    .card-body .col-md-4 {
        flex: 0 0 30%;
        max-width: 30%;
        text-align: center;
    }
    
    .card-body .col-md-8 {
        flex: 0 0 70%;
        max-width: 70%;
    }
    
    /* Carousel improvements for iPad */
    .carousel {
        width: 160px !important;
        height: 160px !important;
    }
    
    .carousel-inner {
        width: 160px !important;
        height: 160px !important;
    }
    
    .carousel-control-prev,
    .carousel-control-next {
        width: 40px;
        height: 40px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.8;
    }
    
    .carousel-control-prev {
        left: -15px;
    }
    
    .carousel-control-next {
        right: -15px;
    }
}

/* iPad Portrait mode */
@media (min-width: 768px) and (max-width: 834px) and (orientation: portrait) {
    .card .col-md-4,
    .card .col-md-3 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .card .col-md-2 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

/* Make carousel touch-friendly on mobile */
@media (max-width: 767px) {
    /* Ensure 50/50 layout is maintained on mobile */
    .row.g-0 .col-6 {
        flex: 0 0 50% !important;
        max-width: 50% !important;
    }
    
    .profile-image-container {
        height: 180px !important;
    }
    
    .carousel-control-prev,
    .carousel-control-next {
        width: 20% !important;
        opacity: 0.7;
    }
    
    .carousel-control-prev {
        left: -15px !important;
    }
    
    .carousel-control-next {
        right: -15px !important;
    }
    
    /* Adjust profile content for mobile */
    .profile-content {
        padding: 0.75rem !important;
    }
    
    .profile-header h6 {
        font-size: 0.85rem !important;
        margin-bottom: 0.25rem !important;
    }
    
    .text-muted.small {
        font-size: 0.7rem !important;
    }
    
    .badge {
        font-size: 0.6rem !important;
        padding: 0.2rem 0.4rem !important;
    }
}

/* Add photo count indicator */
.carousel::after {
    content: attr(data-photo-count);
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    z-index: 10;
}

/* Quiz Widget Styles */
#dailyQuizWidget {
    border-radius: 12px;
    overflow: hidden;
}

#dailyQuizWidget .card-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
}

.quiz-choice {
    transition: all 0.3s ease;
    border-radius: 8px;
    padding: 12px 16px;
    text-align: left;
    border: 2px solid #dee2e6;
}

.quiz-choice:hover {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,123,255,0.3);
}

.quiz-choice:disabled {
    opacity: 0.6;
    transform: none;
    box-shadow: none;
}

.quiz-meta .badge {
    font-size: 0.75rem;
    padding: 0.5em 0.75em;
}

.quiz-result .alert {
    border-radius: 8px;
    border: none;
}

.quiz-stats {
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
}

/* Quiz toggle button */
#quizToggleBtn {
    transition: all 0.3s ease;
}

#quizToggleBtn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

#quizToggleIcon {
    transition: transform 0.3s ease;
}

/* Quiz result enhancements */
.quiz-result .alert {
    animation: slideInDown 0.5s ease-out;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.quiz-result .bg-light {
    transition: all 0.3s ease;
}

.quiz-result .bg-light:hover {
    background-color: #e9ecef !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

{% endblock %}
