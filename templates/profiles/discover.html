<!-- templates/profiles/discover.html -->
{% extends 'base.html' %}
{% load profile_extras %}

{% block title %}Ontdekken - Mooibanana{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active" aria-current="page">
    <i class="fas fa-search"></i> Discover
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4 text-white">Ontdek nieuwe studenten</h2>

            <!-- Bootstrap Search Form -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0 d-flex align-items-center">
                        <i class="fas fa-search me-2"></i> Search Profiles
                        {% if is_searching %}
                            <span class="badge bg-primary ms-2">Active</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get">
                        <!-- First Row -->
                        <div class="row g-3 mb-3">
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.search_query }}
                                    <label for="{{ search_form.search_query.id_for_label }}">{{ search_form.search_query.label }}</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.study_field }}
                                    <label for="{{ search_form.study_field.id_for_label }}">{{ search_form.study_field.label }}</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.school_name }}
                                    <label for="{{ search_form.school_name.id_for_label }}">{{ search_form.school_name.label }}</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.interests }}
                                    <label for="{{ search_form.interests.id_for_label }}">{{ search_form.interests.label }}</label>
                                </div>
                            </div>
                        </div>

                        <!-- Second Row -->
                        <div class="row g-3 mb-3">
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.city }}
                                    <label for="{{ search_form.city.id_for_label }}">{{ search_form.city.label }}</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.location }}
                                    <label for="{{ search_form.location.id_for_label }}">{{ search_form.location.label }}</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="form-floating">
                                    {{ search_form.max_distance }}
                                    <label for="{{ search_form.max_distance.id_for_label }}">{{ search_form.max_distance.label }}</label>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 d-flex align-items-end">
                                <div class="btn-group w-100" role="group">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-search me-1"></i> Search
                                    </button>
                                    <a href="{% url 'profiles:discover' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i> Clear
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Active Filters Alert -->
                    {% if is_searching %}
                    <div class="alert alert-info border-0 mt-3">
                        <small class="mb-0">
                            <strong><i class="fas fa-filter me-1"></i>Active filters:</strong>
                            {% if search_params.search_query %}<span class="badge bg-secondary me-1">Name: "{{ search_params.search_query }}"</span>{% endif %}
                            {% if search_params.study_field %}<span class="badge bg-secondary me-1">Study: "{{ search_form.study_field.field.choices|lookup:search_params.study_field }}"</span>{% endif %}
                            {% if search_params.school_name %}<span class="badge bg-secondary me-1">School: "{{ search_params.school_name }}"</span>{% endif %}
                            {% if search_params.interests %}<span class="badge bg-secondary me-1">Interests: "{{ search_params.interests }}"</span>{% endif %}
                            {% if search_params.city %}<span class="badge bg-secondary me-1">City: "{{ search_params.city }}"</span>{% endif %}
                            {% if search_params.location %}<span class="badge bg-secondary me-1">Region: "{{ search_params.location }}"</span>{% endif %}
                            {% if search_params.max_distance %}<span class="badge bg-secondary me-1">Max Distance: {{ search_params.max_distance }}km</span>{% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>



        <!-- 2x2 Grid Layout for larger screens, single column for mobile -->
        <div class="row">
            {% for profile in profiles %}
            <div class="col-12 col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                {% with all_photos=profile.get_all_photos %}
                                {% if all_photos %}
                                    <div id="carousel-{{ profile.id }}" class="carousel slide" data-bs-ride="false" data-photo-count="1/{{ all_photos|length }}" style="width: 150px; height: 150px; margin: 0 auto; position: relative;">
                                        <div class="carousel-inner" style="border-radius: 50%; overflow: hidden;">
                                            {% for photo in all_photos %}
                                            <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                                <img src="{{ photo.url }}" class="d-block w-100" style="width: 150px; height: 150px; object-fit: cover;" alt="{{ profile.user.username }}">
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% if all_photos|length > 1 %}
                                        <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ profile.id }}" data-bs-slide="prev" style="width: 15%; left: -10px;">
                                            <span class="carousel-control-prev-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.5); border-radius: 50%; width: 20px; height: 20px;"></span>
                                            <span class="visually-hidden">Previous</span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ profile.id }}" data-bs-slide="next" style="width: 15%; right: -10px;">
                                            <span class="carousel-control-next-icon" aria-hidden="true" style="background-color: rgba(0,0,0,0.5); border-radius: 50%; width: 20px; height: 20px;"></span>
                                            <span class="visually-hidden">Next</span>
                                        </button>
                                        {% endif %}
                                        {% if all_photos|length > 1 %}
                                        <div class="carousel-indicators" style="bottom: -20px; margin-bottom: 0;">
                                            {% for photo in all_photos %}
                                            <button type="button" data-bs-target="#carousel-{{ profile.id }}" data-bs-slide-to="{{ forloop.counter0 }}" {% if forloop.first %}class="active" aria-current="true"{% endif %} aria-label="Slide {{ forloop.counter }}" style="width: 6px; height: 6px; border-radius: 50%; margin: 0 2px;"></button>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 150px; height: 150px;">
                                        <i class="fas fa-user fa-3x text-muted"></i>
                                    </div>
                                {% endif %}
                                {% endwith %}
                            </div>
                            <div class="col-md-8">
                                <h5>{{ profile.user.username }}
                                    {% if profile.age %}
                                        <span class="text-muted">, {{ profile.age }}</span>
                                    {% endif %}
                                </h5>

                                {% if profile.study_field %}
                                <p class="small"><strong>Studie:</strong> {{ profile.get_study_field_display }}
                                    {% if profile.study_year %} - Jaar {{ profile.study_year }}{% endif %}
                                </p>
                                {% endif %}

                                {% if profile.school_name %}
                                <p class="small"><strong>School:</strong> {{ profile.school_name }}</p>
                                {% endif %}

                                {% if profile.city %}
                                <p class="small"><strong>Stad:</strong> {{ profile.city }}</p>
                                {% endif %}

                                {% if profile.location %}
                                <p class="small"><strong>Regio:</strong> {{ profile.location }}</p>
                                {% endif %}

                                {% if profile_distances and profile.id in profile_distances %}
                                <p class="small text-primary"><strong>Afstand:</strong> {{ profile_distances|lookup:profile.id }}km</p>
                                {% endif %}

                                {% if profile.bio %}
                                <p class="text-muted small">{{ profile.bio|truncatewords:20 }}</p>
                                {% endif %}

                                {% if profile.get_interests_list %}
                                <div class="mb-2">
                                    {% for interest in profile.get_interests_list|slice:":3" %}
                                        <span class="badge bg-secondary me-1 small">{{ interest }}</span>
                                    {% endfor %}
                                    {% if profile.get_interests_list|length > 3 %}
                                        <span class="text-muted small">+{{ profile.get_interests_list|length|add:"-3" }} more</span>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Bootstrap Action Buttons -->
                                <div class="d-grid">
                                    <a href="{% url 'profiles:profile_detail' profile.id %}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i> View Profile
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center text-white">
                <h4>Geen profielen gevonden</h4>
                <p>Er zijn geen nieuwe profielen om te ontdekken. Kom later terug!</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- Bootstrap Pagination -->
        {% if is_paginated %}
        <div class="row">
            <div class="col-12">
                <nav aria-label="Profile pagination" class="mt-4">
                    <ul class="pagination justify-content-center flex-wrap">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' 1 %}">
                                    <i class="fas fa-angle-double-left me-1"></i>Eerste
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' page_obj.previous_page_number %}">
                                    <i class="fas fa-angle-left me-1"></i>Vorige
                                </a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                {{ page_obj.number }} van {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' page_obj.next_page_number %}">
                                    Volgende<i class="fas fa-angle-right ms-1"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% url_replace request 'page' page_obj.paginator.num_pages %}">
                                    Laatste<i class="fas fa-angle-double-right ms-1"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-submit search form when study field changes
document.addEventListener('DOMContentLoaded', function() {
    const studyField = document.getElementById('id_study_field');
    if (studyField) {
        studyField.addEventListener('change', function() {
            // Auto-submit form when study field changes
            this.form.submit();
        });
    }

    // Add search suggestions for interests
    const interestsInput = document.getElementById('id_interests');
    if (interestsInput) {
        const commonInterests = [
            'football', 'basketball', 'tennis', 'swimming', 'running',
            'music', 'guitar', 'piano', 'singing', 'dancing',
            'reading', 'writing', 'photography', 'art', 'painting',
            'cooking', 'traveling', 'hiking', 'cycling', 'gaming',
            'movies', 'series', 'anime', 'programming', 'technology',
            'fitness', 'yoga', 'meditation', 'volunteering', 'languages'
        ];

        // Create datalist for autocomplete
        const datalist = document.createElement('datalist');
        datalist.id = 'interests-suggestions';
        commonInterests.forEach(interest => {
            const option = document.createElement('option');
            option.value = interest;
            datalist.appendChild(option);
        });

        interestsInput.setAttribute('list', 'interests-suggestions');
        interestsInput.parentNode.appendChild(datalist);
    }

    // Clear form functionality
    const clearBtn = document.querySelector('a[href*="discover"]');
    if (clearBtn && clearBtn.textContent.includes('Clear')) {
        clearBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Clear all form fields
            const form = document.querySelector('form[method="get"]');
            if (form) {
                form.reset();
                // Redirect to discover page without parameters
                window.location.href = '{% url "profiles:discover" %}';
            }
        });
    }
});

// Update photo counters when carousel slides
document.addEventListener('DOMContentLoaded', function() {
    const carousels = document.querySelectorAll('.carousel');
    
    carousels.forEach(function(carousel) {
        carousel.addEventListener('slid.bs.carousel', function(e) {
            const activeIndex = Array.from(e.target.querySelectorAll('.carousel-item')).indexOf(e.relatedTarget) + 1;
            const totalPhotos = e.target.querySelectorAll('.carousel-item').length;
            e.target.setAttribute('data-photo-count', `${activeIndex}/${totalPhotos}`);
        });
        
        // Add touch/swipe support for mobile
        let startX = 0;
        let endX = 0;
        
        carousel.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
        }, { passive: true });
        
        carousel.addEventListener('touchend', function(e) {
            endX = e.changedTouches[0].clientX;
            const diff = startX - endX;
            
            if (Math.abs(diff) > 50) { // Minimum swipe distance
                const carouselInstance = bootstrap.Carousel.getOrCreateInstance(carousel);
                if (diff > 0) {
                    carouselInstance.next(); // Swipe left = next
                } else {
                    carouselInstance.prev(); // Swipe right = previous
                }
            }
        }, { passive: true });
    });
});
</script>

<style>
/* Custom styles for profile image carousel */
.carousel-control-prev:hover,
.carousel-control-next:hover {
    opacity: 0.8;
}

.carousel-control-prev-icon,
.carousel-control-next-icon {
    transition: all 0.2s ease;
}

.carousel-control-prev-icon:hover,
.carousel-control-next-icon:hover {
    transform: scale(1.1);
}

.carousel-indicators button {
    transition: all 0.2s ease;
}

.carousel-indicators button:hover {
    opacity: 0.8;
    transform: scale(1.2);
}

/* iPad and Tablet specific improvements */
@media (min-width: 768px) and (max-width: 1024px) {
    /* Search form on iPad */
    .card .row.g-3 {
        margin: 0;
    }
    
    .card .col-md-4,
    .card .col-md-3,
    .card .col-md-2 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 15px;
    }
    
    /* Profile grid adjustments for iPad */
    .col-lg-6 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 25px;
    }
    
    /* Profile cards spacing */
    .card-body .row {
        align-items: center;
    }
    
    .card-body .col-md-4 {
        flex: 0 0 30%;
        max-width: 30%;
        text-align: center;
    }
    
    .card-body .col-md-8 {
        flex: 0 0 70%;
        max-width: 70%;
    }
    
    /* Carousel improvements for iPad */
    .carousel {
        width: 160px !important;
        height: 160px !important;
    }
    
    .carousel-inner {
        width: 160px !important;
        height: 160px !important;
    }
    
    .carousel-control-prev,
    .carousel-control-next {
        width: 40px;
        height: 40px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.8;
    }
    
    .carousel-control-prev {
        left: -15px;
    }
    
    .carousel-control-next {
        right: -15px;
    }
}

/* iPad Portrait mode */
@media (min-width: 768px) and (max-width: 834px) and (orientation: portrait) {
    .card .col-md-4,
    .card .col-md-3 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .card .col-md-2 {
        flex: 0 0 50%;
        max-width: 50%;
    }
}

/* Make carousel touch-friendly on mobile */
@media (max-width: 767px) {
    .carousel-control-prev,
    .carousel-control-next {
        width: 20% !important;
        opacity: 0.7;
    }
    
    .carousel-control-prev {
        left: -15px !important;
    }
    
    .carousel-control-next {
        right: -15px !important;
    }
}

/* Add photo count indicator */
.carousel::after {
    content: attr(data-photo-count);
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    z-index: 10;
}
</style>

{% endblock %}
