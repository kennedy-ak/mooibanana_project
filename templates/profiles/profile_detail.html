{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ profile.user.get_full_name|default:profile.user.username }} - Mooibanana{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
    <a href="{% url 'profiles:discover' %}" class="text-decoration-none">
        <i class="fas fa-search"></i> Discover
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    {{ profile.user.username }}'s Profile
</li>
{% endblock %}

{% block quick_actions %}
{{ block.super }}
{% if user.is_authenticated and user != profile.user %}
<div class="btn-group" role="group" aria-label="Profile actions">
    <a href="{% url 'likes:give_like' profile.user.id %}" class="btn btn-success btn-sm" title="Give Like">
        <i class="fas fa-heart"></i>
    </a>
    <a href="{% url 'likes:give_unlike' profile.user.id %}" class="btn btn-danger btn-sm" title="Give Dislike">
        <i class="fas fa-times-circle"></i>
    </a>
</div>
{% endif %}
{% endblock %}

{% block quick_actions_mobile %}
{% if user.is_authenticated and user != profile.user %}
<li>
    <a href="{% url 'likes:give_like' profile.user.id %}" class="dropdown-item text-success">
        <i class="fas fa-heart me-2"></i>Give Like
    </a>
</li>
<li>
    <a href="{% url 'likes:give_unlike' profile.user.id %}" class="dropdown-item text-danger">
        <i class="fas fa-times-circle me-2"></i>Give Dislike
    </a>
</li>
<li><hr class="dropdown-divider"></li>
{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <!-- Photo Slider -->
                    {% with all_photos=profile.get_all_photos %}
                    {% if all_photos %}
                        <div id="profilePhotoCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for photo in all_photos %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ photo.url }}" alt="{{ profile.user.username }}"
                                         class="d-block w-100 rounded" style="height: 300px; object-fit: cover;">
                                </div>
                                {% endfor %}
                            </div>
                            {% if all_photos|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#profilePhotoCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#profilePhotoCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            <!-- Indicators -->
                            <div class="carousel-indicators">
                                {% for photo in all_photos %}
                                <button type="button" data-bs-target="#profilePhotoCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                                        {% if forloop.first %}class="active"{% endif %} aria-current="true" aria-label="Slide {{ forloop.counter }}"></button>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3 mx-auto"
                             style="height: 300px;">
                            <i class="fas fa-user fa-4x text-muted"></i>
                        </div>
                    {% endif %}
                    {% endwith %}
                    
                    <h4 class="card-title">{{ profile.user.get_full_name|default:profile.user.username }}</h4>
                    
                    {% if profile.age %}
                        <p class="text-muted">{{ profile.age }} jaar</p>
                    {% endif %}
                    
                    {% if profile.study_program %}
                        <p class="text-primary">
                            <i class="fas fa-graduation-cap"></i> {{ profile.study_program }}
                        </p>
                    {% endif %}
                    
                    {% if profile.school_name %}
                        <p class="text-muted">
                            <i class="fas fa-university"></i> {{ profile.school_name }}
                        </p>
                    {% endif %}
                    
                    <!-- TEMPORARILY DISABLED - Match Request Notification Alert -->
                    {% comment %}
                    {% if match_request_notification %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-heart text-danger"></i> Match Request</h6>
                        <p class="mb-2">{{ profile.user.username }} wants to match with you!</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="respondToMatchFromProfile({{ match_request_notification.id }}, 'accept')">
                                <i class="fas fa-heart"></i> Accept Match
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="respondToMatchFromProfile({{ match_request_notification.id }}, 'decline')">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                    {% elif incoming_match_request %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-heart text-danger"></i> Match Request</h6>
                        <p class="mb-2">{{ profile.user.username }} wants to match with you!</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="respondToMatchFromProfile({{ incoming_match_request.id }}, 'accept')">
                                <i class="fas fa-heart"></i> Accept Match
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="respondToMatchFromProfile({{ incoming_match_request.id }}, 'decline')">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endcomment %}

                    <!-- Manage Photos Button (for profile owner) -->
                    {% if user.is_authenticated and user == profile.user %}
                        <div class="d-grid gap-2 mt-4">
                            <a href="{% url 'profiles:upload_photos' %}" class="btn btn-primary w-100">
                                <i class="fas fa-images"></i> {% trans "Manage Photos" %}
                            </a>
                        </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    {% if user.is_authenticated and user != profile.user %}
                        <div class="d-grid gap-2 mt-4">
                            <!-- Buy Likes Button -->
                            <button type="button" class="btn w-100" style="background-color: #ff8c00; color: white; border: none;" data-bs-toggle="modal" data-bs-target="#giftLikesModal">
                                <i class="fas fa-gift"></i> {% trans "Buy Likes for" %} {{ profile.user.first_name|default:profile.user.username }}
                            </button>
                            
                            <!-- Buy Dislikes Button -->
                            <button type="button" class="btn w-100" style="background-color: #dc3545; color: white; border: none;" data-bs-toggle="modal" data-bs-target="#giftDislikesModal">
                                <i class="fas fa-times-circle"></i> {% trans "Buy Dislikes for" %} {{ profile.user.first_name|default:profile.user.username }}
                            </button>
                        </div>
                    {% endif %}

                    <!-- Bootstrap Statistics Section -->
                    {% if user.is_authenticated and user != profile.user %}
                        <div class="card mt-4 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 text-center">
                                <h6 class="card-title mb-0">{% trans "Available Balances" %}</h6>
                            </div>
                            <div class="card-body text-center py-3">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
                                            <span class="badge likes-balance fs-6 px-3 py-2">
                                                <i class="fas fa-heart me-1"></i> {{ profile.user.likes_balance }} likes
                                            </span>
                                            <span class="badge bg-danger fs-6 px-3 py-2">
                                                <i class="fas fa-times-circle me-1"></i> {{ profile.user.unlikes_balance }} unlikes
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Bootstrap Stats Card -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-transparent border-0">
                    <h6 class="card-title text-center mb-0">Beschikbare Balansen</h6>
                </div>
                <div class="card-body text-center py-3">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
                                <span class="badge likes-balance fs-6 px-3 py-2">
                                    <i class="fas fa-heart me-1"></i> {{ profile.user.likes_balance }} likes
                                </span>
                                <span class="badge bg-danger fs-6 px-3 py-2">
                                    <i class="fas fa-times-circle me-1"></i> {{ profile.user.unlikes_balance }} unlikes
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Details -->
        <div class="col-lg-8">
            <!-- About me Section -->
            {% if profile.bio %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle text-primary"></i> {% trans "About me" %}
                        </h5>
                        <p class="card-text">{{ profile.bio|linebreaks }}</p>
                    </div>
                </div>
            {% endif %}

            <!-- Interests Section -->
            {% if profile.interests %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heart text-primary"></i> {% trans "Interests" %}
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for interest in profile.get_interests_list %}
                                <span class="badge bg-primary">{{ interest }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Profile Information Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-user text-primary"></i> {% trans "Profile Information" %}
                    </h5>
                    <div class="row">
                        {% if profile.location %}
                        <div class="col-md-6 mb-2">
                            <strong>{% trans "Location" %}:</strong> {{ profile.location }}
                        </div>
                        {% endif %}
                        {% if profile.study_year %}
                        <div class="col-md-6 mb-2">
                            <strong>{% trans "Academic year" %}:</strong> {{ profile.study_year }}
                        </div>
                        {% endif %}
                        {% if profile.city %}
                        <div class="col-md-6 mb-2">
                            <strong>{% trans "City" %}:</strong> {{ profile.city }}
                        </div>
                        {% endif %}
                        {% if profile.school_name %}
                        <div class="col-md-6 mb-2">
                            <strong>{% trans "School" %}:</strong> {{ profile.school_name }}
                        </div>
                        {% endif %}
                        {% if profile.study_field %}
                        <div class="col-md-6 mb-2">
                            <strong>{% trans "Study field" %}:</strong> {{ profile.study_field }}
                        </div>
                        {% endif %}
                        <div class="col-md-6 mb-2">
                            <strong>{% trans "Member since" %}:</strong> {{ profile.user.date_joined|date:"F Y" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verification Warning -->
            {% if user.is_authenticated and user != profile.user %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> {% trans "This profile has not yet been verified. Please be careful when sharing personal information." %}
                </div>
            {% endif %}
            
            <!-- Hobbies Section -->
            {% if profile.hobbies %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-gamepad text-primary"></i> Hobby's
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for hobby in profile.get_hobbies_list %}
                                <span class="badge bg-secondary">{{ hobby }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Additional Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-user-circle text-primary"></i> Profielinformatie
                    </h5>
                    <div class="row">
                        {% if profile.gender %}
                            <div class="col-md-6 mb-3">
                                <strong>Geslacht:</strong>
                                <span class="text-muted">{{ profile.get_gender_display }}</span>
                            </div>
                        {% endif %}
                        
                        {% if profile.city %}
                            <div class="col-md-6 mb-3">
                                <strong>Stad:</strong>
                                <span class="text-muted">{{ profile.city }}</span>
                            </div>
                        {% endif %}

                        {% if profile.location %}
                            <div class="col-md-6 mb-3">
                                <strong>Regio:</strong>
                                <span class="text-muted">{{ profile.location }}</span>
                            </div>
                        {% endif %}
                        
                        {% if profile.study_year %}
                            <div class="col-md-6 mb-3">
                                <strong>Studiejaar:</strong>
                                <span class="text-muted">{{ profile.study_year }}</span>
                            </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-3">
                            <strong>Lid sinds:</strong>
                            <span class="text-muted">{{ profile.user.date_joined|date:"F Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Photos Section -->
            {% if profile.photos.exists %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-images text-primary"></i> Foto's
                        </h5>
                        <div class="row">
                            {% for photo in profile.photos.all %}
                                <div class="col-md-4 mb-3">
                                    <img src="{{ photo.image.url }}" alt="Foto" 
                                         class="img-fluid rounded shadow-sm" 
                                         style="height: 200px; width: 100%; object-fit: cover;">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Warning for unverified users -->
            {% if not profile.is_verified %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    Dit profiel is nog niet geverifieerd. Wees voorzichtig bij het delen van persoonlijke informatie.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Gift Likes Modal -->
{% if user.is_authenticated and user != profile.user %}
<div class="modal fade" id="giftLikesModal" tabindex="-1" aria-labelledby="giftLikesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%); color: white;">
                <h5 class="modal-title" id="giftLikesModalLabel">
                    <i class="fas fa-gift"></i> Koop Likes Voor {{ profile.user.first_name|default:profile.user.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p class="lead">Laat {{ profile.user.first_name|default:profile.user.username }} weten hoe speciaal je hem/haar vindt!</p>
                    <p class="text-muted">Koop een like pakket en alle likes gaan direct naar {{ profile.user.first_name|default:profile.user.username }}'s account.</p>
                </div>

                <!-- Direct link to packages page -->
                <div class="text-center mb-4">
                    <a href="{% url 'payments:packages' %}" class="btn btn-primary btn-lg">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Ga naar Like Pakketten
                    </a>
                </div>

                <hr class="my-4">

                <div class="text-center mb-3">
                    <h6 class="text-muted">Of kies een pakket hieronder:</h6>
                </div>

                <div class="row" id="giftPackages">
                    <!-- Packages will be loaded here -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gift Dislikes Modal -->
<div class="modal fade" id="giftDislikesModal" tabindex="-1" aria-labelledby="giftDislikesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%); color: white;">
                <h5 class="modal-title" id="giftDislikesModalLabel">
                    <i class="fas fa-times-circle"></i> {% trans "Buy Dislikes for" %} {{ profile.user.first_name|default:profile.user.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p class="lead">{% trans "Purchase dislike packages" %}</p>
                    <p class="text-muted">{% trans "Choose from packages with unlikes/dislikes to use on profiles." %}</p>
                </div>

                <!-- Direct link to packages page with unlikes filter -->
                <div class="text-center mb-4">
                    <a href="{% url 'payments:packages' %}?type=unlikes" class="btn btn-danger btn-lg">
                        <i class="fas fa-shopping-cart me-2"></i>
                        {% trans "Go to Dislike Packages" %}
                    </a>
                </div>

                <hr class="my-4">

                <div class="text-center mb-3">
                    <h6 class="text-muted">{% trans "Or choose a package below:" %}</h6>
                </div>

                <div class="row" id="giftDislikePackages">
                    <!-- Packages will be loaded here -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Like Success Modal -->
<div class="modal fade" id="likeSuccessModal" tabindex="-1" aria-labelledby="likeSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="likeSuccessModalLabel">
                    <i class="fas fa-heart"></i> Like Gegeven!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>Je hebt succesvol een like gegeven aan {{ profile.user.get_full_name|default:profile.user.username }}!</p>
                <p class="text-muted">Als deze persoon jou ook een like geeft, krijgen jullie een match en kunnen jullie chatten.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Oké</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Show success modal if like was given (you can pass this from the view)
    {% if messages %}
        {% for message in messages %}
            {% if 'like' in message.tags %}
                var likeModal = new bootstrap.Modal(document.getElementById('likeSuccessModal'));
                likeModal.show();
            {% endif %}
        {% endfor %}
    {% endif %}

    // Load gift packages when modal opens
    document.getElementById('giftLikesModal').addEventListener('show.bs.modal', function () {
        fetch('/payments/api/packages/')
            .then(response => response.json())
            .then(data => {
                const packagesContainer = document.getElementById('giftPackages');
                packagesContainer.innerHTML = '';
                
                data.packages.forEach(package => {
                    const isPopular = package.name.toLowerCase().includes('populair') || package.name.toLowerCase().includes('popular');
                    
                    const packageHtml = `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 ${isPopular ? 'border-warning' : ''}">
                                <div class="card-header text-center ${isPopular ? 'bg-warning text-dark' : 'bg-primary text-white'}">
                                    <h6 class="mb-0">${package.name}</h6>
                                    ${isPopular ? '<small class="badge bg-dark">POPULAIR</small>' : ''}
                                </div>
                                <div class="card-body text-center">
                                    <div class="h4 text-primary mb-2">€${package.price}</div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block"><i class="fas fa-heart text-danger"></i> ${package.regular_likes} Regular Likes</small>
                                        ${package.super_likes > 0 ? `<small class="text-muted d-block"><i class="fas fa-star text-warning"></i> ${package.super_likes} Super Likes</small>` : ''}
                                        ${package.boosters > 0 ? `<small class="text-muted d-block"><i class="fas fa-rocket text-info"></i> ${package.boosters} Boosters</small>` : ''}
                                    </div>
                                    <button onclick="giftPackage(${package.id})" class="btn ${isPopular ? 'btn-warning' : 'btn-primary'} btn-sm w-100">
                                        <i class="fas fa-gift"></i> Cadeau Geven
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    packagesContainer.innerHTML += packageHtml;
                });
            })
            .catch(error => {
                console.error('Error loading packages:', error);
                document.getElementById('giftPackages').innerHTML = 
                    '<div class="col-12 text-center"><div class="alert alert-danger">Error loading packages</div></div>';
            });
    });

    // Load gift dislike packages when modal opens
    document.getElementById('giftDislikesModal').addEventListener('show.bs.modal', function () {
        fetch('/payments/api/packages/')
            .then(response => response.json())
            .then(data => {
                const packagesContainer = document.getElementById('giftDislikePackages');
                packagesContainer.innerHTML = '';
                
                // Filter packages that have unlikes
                const dislikePackages = data.packages.filter(package => package.unlikes > 0);
                
                if (dislikePackages.length === 0) {
                    packagesContainer.innerHTML = '<div class="col-12 text-center"><div class="alert alert-info">No dislike packages available</div></div>';
                    return;
                }
                
                dislikePackages.forEach(package => {
                    const isPopular = package.name.toLowerCase().includes('populair') || package.name.toLowerCase().includes('popular');
                    
                    const packageHtml = `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 ${isPopular ? 'border-danger' : ''}">
                                <div class="card-header text-center ${isPopular ? 'bg-danger text-white' : 'bg-dark text-white'}">
                                    <h6 class="mb-0">${package.name}</h6>
                                    ${isPopular ? '<small class="badge bg-light text-dark">POPULAIR</small>' : ''}
                                </div>
                                <div class="card-body text-center">
                                    <div class="h4 text-danger mb-2">€${package.price}</div>
                                    <div class="mb-3">
                                        ${package.unlikes > 0 ? `<small class="text-muted d-block"><i class="fas fa-times-circle text-danger"></i> ${package.unlikes} Dislikes</small>` : ''}
                                        ${package.regular_likes > 0 ? `<small class="text-muted d-block"><i class="fas fa-heart text-danger"></i> ${package.regular_likes} Regular Likes</small>` : ''}
                                        ${package.super_likes > 0 ? `<small class="text-muted d-block"><i class="fas fa-star text-warning"></i> ${package.super_likes} Super Likes</small>` : ''}
                                        ${package.boosters > 0 ? `<small class="text-muted d-block"><i class="fas fa-rocket text-info"></i> ${package.boosters} Boosters</small>` : ''}
                                    </div>
                                    <button onclick="giftPackage(${package.id})" class="btn ${isPopular ? 'btn-danger' : 'btn-dark'} btn-sm w-100">
                                        <i class="fas fa-gift"></i> Cadeau Geven
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    packagesContainer.innerHTML += packageHtml;
                });
            })
            .catch(error => {
                console.error('Error loading dislike packages:', error);
                document.getElementById('giftDislikePackages').innerHTML = 
                    '<div class="col-12 text-center"><div class="alert alert-danger">Error loading packages</div></div>';
            });
    });

    // Handle gift package purchase
    function giftPackage(packageId) {
        const recipientId = {{ profile.user.id }};
        const recipientName = '{{ profile.user.first_name|default:profile.user.username }}';

        // Redirect to gift purchase page
        window.location.href = `/payments/gift/${packageId}/${recipientId}/`;
    }

    // Handle match request response from profile page
    function respondToMatchFromProfile(notificationId, action) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(`/notifications/respond/${notificationId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // Insert after the match request alert
                const matchRequestAlert = document.querySelector('.alert-info');
                if (matchRequestAlert) {
                    matchRequestAlert.style.display = 'none';
                    matchRequestAlert.parentNode.insertBefore(alertDiv, matchRequestAlert.nextSibling);
                }

                // Redirect if it's a match
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                } else {
                    // Reload page after 2 seconds to update the UI
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        })
        .catch(error => console.error('Error responding to match:', error));
    }
</script>

<style>
/* iPad specific improvements for profile detail */
@media (min-width: 768px) and (max-width: 1024px) {
    .container {
        padding: 0 20px;
    }
    
    /* Profile layout adjustments */
    .col-lg-4, .col-lg-8 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 30px;
    }
    
    /* Profile card improvements */
    .card-body {
        padding: 25px;
    }
    
    /* Carousel sizing for iPad */
    #profilePhotoCarousel {
        width: 200px !important;
        height: 200px !important;
        margin: 0 auto 20px;
    }
    
    .carousel-inner img {
        width: 200px !important;
        height: 200px !important;
    }
    
    /* Button improvements */
    .btn {
        min-height: 44px;
        padding: 12px 20px;
        font-size: 1rem;
    }
    
    .btn-sm {
        min-height: 40px;
        padding: 10px 16px;
        font-size: 0.9rem;
    }
    
    /* Modal improvements for iPad */
    .modal-dialog {
        margin: 40px auto;
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 15px;
    }
    
    /* Profile info layout */
    .card-title {
        font-size: 1.4rem;
        margin-bottom: 15px;
    }
    
    /* Statistics section */
    .nav-item .likes-balance {
        font-size: 1rem;
        padding: 8px 16px;
        display: block;
        text-align: center;
        margin: 10px 0;
    }
    
    /* Action buttons spacing */
    .d-grid .btn {
        margin-bottom: 12px;
    }
    
    /* Photo grid improvements */
    .row .col-md-4 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 20px;
    }
}

/* iPad Portrait specific */
@media (min-width: 768px) and (max-width: 834px) and (orientation: portrait) {
    .row .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 20px;
    }
    
    /* Single column layout for better readability */
    .col-lg-4 {
        order: 1;
    }
    
    .col-lg-8 {
        order: 2;
    }
}

/* Touch-friendly improvements */
@media (pointer: coarse) {
    .carousel-control-prev,
    .carousel-control-next {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0,0,0,0.6);
    }
    
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        width: 24px;
        height: 24px;
    }
    
    .carousel-indicators button {
        width: 12px;
        height: 12px;
        margin: 0 4px;
    }
    
    /* Form elements */
    input, select, textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        min-height: 44px;
    }
}
</style>
{% endblock %}