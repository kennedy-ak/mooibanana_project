{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile.user.get_full_name|default:profile.user.username }} - Mooibanana{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
    <a href="{% url 'profiles:discover' %}" class="text-decoration-none">
        <i class="fas fa-search"></i> Discover
    </a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    {{ profile.user.username }}'s Profile
</li>
{% endblock %}

{% block quick_actions %}
{{ block.super }}
{% if user.is_authenticated and user != profile.user %}
<div class="btn-group" role="group" aria-label="Profile actions">
    <a href="{% url 'likes:give_like' profile.user.id %}" class="btn btn-success btn-sm" title="Give Like">
        <i class="fas fa-heart"></i>
    </a>
    <a href="{% url 'likes:give_unlike' profile.user.id %}" class="btn btn-danger btn-sm" title="Give Dislike">
        <i class="fas fa-times-circle"></i>
    </a>
</div>
{% endif %}
{% endblock %}

{% block quick_actions_mobile %}
{% if user.is_authenticated and user != profile.user %}
<li>
    <a href="{% url 'likes:give_like' profile.user.id %}" class="dropdown-item text-success">
        <i class="fas fa-heart me-2"></i>Give Like
    </a>
</li>
<li>
    <a href="{% url 'likes:give_unlike' profile.user.id %}" class="dropdown-item text-danger">
        <i class="fas fa-times-circle me-2"></i>Give Dislike
    </a>
</li>
<li><hr class="dropdown-divider"></li>
{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <!-- Photo Slider -->
                    {% with all_photos=profile.get_all_photos %}
                    {% if all_photos %}
                        <div id="profilePhotoCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for photo in all_photos %}
                                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                    <img src="{{ photo.url }}" alt="{{ profile.user.username }}"
                                         class="d-block w-100 rounded" style="height: 300px; object-fit: cover;">
                                </div>
                                {% endfor %}
                            </div>
                            {% if all_photos|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#profilePhotoCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#profilePhotoCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                            <!-- Indicators -->
                            <div class="carousel-indicators">
                                {% for photo in all_photos %}
                                <button type="button" data-bs-target="#profilePhotoCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                                        {% if forloop.first %}class="active"{% endif %} aria-current="true" aria-label="Slide {{ forloop.counter }}"></button>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3 mx-auto"
                             style="height: 300px;">
                            <i class="fas fa-user fa-4x text-muted"></i>
                        </div>
                    {% endif %}
                    {% endwith %}
                    
                    <h4 class="card-title">{{ profile.user.get_full_name|default:profile.user.username }}</h4>
                    
                    {% if profile.age %}
                        <p class="text-muted">{{ profile.age }} years old</p>
                    {% endif %}
                    
                    {% if profile.study_program %}
                        <p class="text-primary">
                            <i class="fas fa-graduation-cap"></i> {{ profile.study_program }}
                        </p>
                    {% endif %}
                    
                    {% if profile.school_name %}
                        <p class="text-muted">
                            <i class="fas fa-university"></i> {{ profile.school_name }}
                        </p>
                    {% endif %}
                    
                    <!-- TEMPORARILY DISABLED - Match Request Notification Alert -->
                    {% comment %}
                    {% if match_request_notification %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-heart text-danger"></i> Match Request</h6>
                        <p class="mb-2">{{ profile.user.username }} wants to match with you!</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="respondToMatchFromProfile({{ match_request_notification.id }}, 'accept')">
                                <i class="fas fa-heart"></i> Accept Match
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="respondToMatchFromProfile({{ match_request_notification.id }}, 'decline')">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                    {% elif incoming_match_request %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-heart text-danger"></i> Match Request</h6>
                        <p class="mb-2">{{ profile.user.username }} wants to match with you!</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success btn-sm" onclick="respondToMatchFromProfile({{ incoming_match_request.id }}, 'accept')">
                                <i class="fas fa-heart"></i> Accept Match
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="respondToMatchFromProfile({{ incoming_match_request.id }}, 'decline')">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endcomment %}

                    <!-- Manage Photos Button (for profile owner) -->
                    {% if user.is_authenticated and user == profile.user %}
                        <div class="d-grid gap-2 mt-4">
                            <a href="{% url 'profiles:upload_photos' %}" class="btn btn-primary w-100">
                                <i class="fas fa-images"></i> Manage Photos
                            </a>
                        </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    {% if user.is_authenticated and user != profile.user %}
                        <div class="d-grid gap-2 mt-4">
                            <!-- Give Likes Button -->
                            <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#giveLikesModal">
                                <i class="fas fa-heart"></i> Give Likes
                            </button>
                            
                            <!-- Give Dislikes Button -->
                            <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#giveDislikesModal">
                                <i class="fas fa-times-circle"></i> Give Dislikes
                            </button>
                            
                        </div>
                    {% endif %}

                    <!-- Bootstrap Statistics Section - Show Current User's Balances -->
                    {% if user.is_authenticated and user != profile.user %}
                        <div class="card mt-4 border-0 shadow-sm">
                            <div class="card-header bg-transparent border-0 text-center">
                                <h6 class="card-title mb-0">Your Available Balances</h6>
                            </div>
                            <div class="card-body text-center py-3">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
                                            <span class="badge bg-success fs-6 px-3 py-2">
                                                <i class="fas fa-heart me-1"></i> {{ user.likes_balance }} likes
                                            </span>
                                            <span class="badge bg-warning fs-6 px-3 py-2">
                                                <i class="fas fa-star me-1"></i> {{ user.super_likes_balance }} super likes
                                            </span>
                                            <span class="badge bg-danger fs-6 px-3 py-2">
                                                <i class="fas fa-times-circle me-1"></i> {{ user.unlikes_balance }} unlikes
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Profile Statistics Card -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-transparent border-0">
                    <h6 class="card-title text-center mb-0">Profile Reputation</h6>
                </div>
                <div class="card-body text-center py-3">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <div class="d-flex justify-content-center align-items-center flex-wrap gap-2">
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <i class="fas fa-heart me-1"></i> {{ received_likes_count }} Likes Received
                                </span>
                                <span class="badge bg-danger fs-6 px-3 py-2">
                                    <i class="fas fa-times-circle me-1"></i> {{ received_dislikes_count }} Dislikes Received
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Profile Details -->
        <div class="col-lg-8">
            <!-- About me Section -->
            {% if profile.bio %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle text-primary"></i> About me
                        </h5>
                        <p class="card-text">{{ profile.bio|linebreaks }}</p>
                    </div>
                </div>
            {% endif %}

            <!-- Interests Section -->
            {% if profile.interests %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-heart text-primary"></i> Interests
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for interest in profile.get_interests_list %}
                                <span class="badge bg-primary">{{ interest }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Profile Information Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-user text-primary"></i> Profile Information
                    </h5>
                    <div class="row">
                        {% if profile.location %}
                        <div class="col-md-6 mb-2">
                            <strong>Location:</strong> {{ profile.location }}
                        </div>
                        {% endif %}
                        {% if profile.study_year %}
                        <div class="col-md-6 mb-2">
                            <strong>Academic year:</strong> {{ profile.study_year }}
                        </div>
                        {% endif %}
                        {% if profile.city %}
                        <div class="col-md-6 mb-2">
                            <strong>City:</strong> {{ profile.city }}
                        </div>
                        {% endif %}
                        {% if profile.school_name %}
                        <div class="col-md-6 mb-2">
                            <strong>School:</strong> {{ profile.school_name }}
                        </div>
                        {% endif %}
                        {% if profile.study_field %}
                        <div class="col-md-6 mb-2">
                            <strong>Study field:</strong> {{ profile.study_field }}
                        </div>
                        {% endif %}
                        <div class="col-md-6 mb-2">
                            <strong>Member since:</strong> {{ profile.user.date_joined|date:"F Y" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Advertisements Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-bullhorn text-primary"></i> Featured Brands
                    </h5>
                    <div id="advertisementCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="4000">
                        <div class="carousel-inner" id="advertisementSlides">
                            <!-- Advertisements will be loaded here -->
                            <div class="carousel-item active">
                                <div class="d-flex justify-content-center align-items-center advertisement-container">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading ads...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#advertisementCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#advertisementCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                        <div class="carousel-indicators" id="advertisementIndicators">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verification Warning -->
            {% if user.is_authenticated and user != profile.user %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> This profile has not yet been verified. Please be careful when sharing personal information.
                </div>
            {% endif %}
            
            <!-- Hobbies Section -->
            {% if profile.hobbies %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-gamepad text-primary"></i> Hobbies
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for hobby in profile.get_hobbies_list %}
                                <span class="badge bg-secondary">{{ hobby }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Additional Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-user-circle text-primary"></i> Profile Information
                    </h5>
                    <div class="row">
                        {% if profile.gender %}
                            <div class="col-md-6 mb-3">
                                <strong>Gender:</strong>
                                <span class="text-muted">{{ profile.get_gender_display }}</span>
                            </div>
                        {% endif %}
                        
                        {% if profile.city %}
                            <div class="col-md-6 mb-3">
                                <strong>City:</strong>
                                <span class="text-muted">{{ profile.city }}</span>
                            </div>
                        {% endif %}

                        {% if profile.location %}
                            <div class="col-md-6 mb-3">
                                <strong>Region:</strong>
                                <span class="text-muted">{{ profile.location }}</span>
                            </div>
                        {% endif %}
                        
                        {% if profile.study_year %}
                            <div class="col-md-6 mb-3">
                                <strong>Study Year:</strong>
                                <span class="text-muted">{{ profile.study_year }}</span>
                            </div>
                        {% endif %}
                        
                        <div class="col-md-6 mb-3">
                            <strong>Member since:</strong>
                            <span class="text-muted">{{ profile.user.date_joined|date:"F Y" }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Photos Section -->
            {% if profile.photos.exists %}
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-images text-primary"></i> Photos
                        </h5>
                        <div class="row">
                            {% for photo in profile.photos.all %}
                                <div class="col-md-4 mb-3">
                                    <img src="{{ photo.image.url }}" alt="Photo" 
                                         class="img-fluid rounded shadow-sm" 
                                         style="height: 200px; width: 100%; object-fit: cover;">
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}
            
            <!-- Warning for unverified users -->
            {% if not profile.is_verified %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle"></i>
                    This profile has not yet been verified. Please be careful when sharing personal information.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Give Likes Modal -->
<div class="modal fade" id="giveLikesModal" tabindex="-1" aria-labelledby="giveLikesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="giveLikesModalLabel">
                    <i class="fas fa-heart"></i> Give Likes to {{ profile.user.first_name|default:profile.user.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'likes:give_like' profile.user.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <p class="lead">How many likes do you want to give?</p>
                        <p class="text-muted">You have <strong>{{ user.likes_balance }} regular likes</strong> and <strong>{{ user.super_likes_balance }} super likes</strong> available.</p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="like_type" class="form-label">Like Type:</label>
                        <select name="like_type" id="like_type" class="form-select" onchange="updateLikeBalanceDisplay()">
                            <option value="regular">Regular Like</option>
                            <option value="super">Super Like</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="amount" class="form-label">Number of Likes:</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" onclick="decrementAmount('like')">-</button>
                            <input type="number" name="amount" id="like_amount" class="form-control text-center" value="1" min="1" max="{{ user.likes_balance }}" onchange="validateLikeAmount()">
                            <button type="button" class="btn btn-outline-secondary" onclick="incrementAmount('like')">+</button>
                        </div>
                        <div class="form-text">
                            <span id="like_balance_text">Available: {{ user.likes_balance }} regular likes</span>
                        </div>
                    </div>
                    
                    <div class="range-input mb-3">
                        <input type="range" id="like_range" class="form-range" min="1" max="{{ user.likes_balance }}" value="1" onchange="updateLikeAmountFromRange()">
                        <div class="d-flex justify-content-between">
                            <span>1</span>
                            <span id="like_max_value">{{ user.likes_balance }}</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="give_likes_btn">
                        <i class="fas fa-heart"></i> Give <span id="like_amount_display">1</span> Like(s)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Give Dislikes Modal -->
<div class="modal fade" id="giveDislikesModal" tabindex="-1" aria-labelledby="giveDislikesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="giveDislikesModalLabel">
                    <i class="fas fa-times-circle"></i> Give Dislikes to {{ profile.user.first_name|default:profile.user.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'likes:give_unlike' profile.user.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <p class="lead">How many dislikes do you want to give?</p>
                        <p class="text-muted">You have <strong>{{ user.unlikes_balance }} dislikes</strong> available.</p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dislike_amount" class="form-label">Number of Dislikes:</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" onclick="decrementAmount('dislike')">-</button>
                            <input type="number" name="amount" id="dislike_amount" class="form-control text-center" value="1" min="1" max="{{ user.unlikes_balance }}" onchange="validateDislikeAmount()">
                            <button type="button" class="btn btn-outline-secondary" onclick="incrementAmount('dislike')">+</button>
                        </div>
                        <div class="form-text">Available: {{ user.unlikes_balance }} dislikes</div>
                    </div>
                    
                    <div class="range-input mb-3">
                        <input type="range" id="dislike_range" class="form-range" min="1" max="{{ user.unlikes_balance }}" value="1" onchange="updateDislikeAmountFromRange()">
                        <div class="d-flex justify-content-between">
                            <span>1</span>
                            <span>{{ user.unlikes_balance }}</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="give_dislikes_btn">
                        <i class="fas fa-times-circle"></i> Give <span id="dislike_amount_display">1</span> Dislike(s)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Gift Likes Modal -->
{% if user.is_authenticated and user != profile.user %}
<div class="modal fade" id="giftLikesModal" tabindex="-1" aria-labelledby="giftLikesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%); color: white;">
                <h5 class="modal-title" id="giftLikesModalLabel">
                    <i class="fas fa-gift"></i> Buy Likes For {{ profile.user.first_name|default:profile.user.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p class="lead">Let {{ profile.user.first_name|default:profile.user.username }} know how special you think they are!</p>
                    <p class="text-muted">Buy a like package and all likes go directly to {{ profile.user.first_name|default:profile.user.username }}'s account.</p>
                </div>

                <!-- Direct link to packages page -->
                <div class="text-center mb-4">
                    <a href="{% url 'payments:packages' %}?type=likes" class="btn btn-primary btn-lg">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Go to Like Packages
                    </a>
                </div>

                <hr class="my-4">

                <div class="text-center mb-3">
                    <h6 class="text-muted">Of kies een pakket hieronder:</h6>
                </div>

                <div class="row" id="giftPackages">
                    <!-- Packages will be loaded here -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gift Dislikes Modal -->
<div class="modal fade" id="giftDislikesModal" tabindex="-1" aria-labelledby="giftDislikesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%); color: white;">
                <h5 class="modal-title" id="giftDislikesModalLabel">
                    <i class="fas fa-times-circle"></i> Buy Dislikes for {{ profile.user.first_name|default:profile.user.username }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <p class="lead">Purchase dislike packages</p>
                    <p class="text-muted">Choose from packages with unlikes/dislikes to use on profiles.</p>
                </div>

                <!-- Direct link to packages page with unlikes filter -->
                <div class="text-center mb-4">
                    <a href="{% url 'payments:packages' %}?type=dislikes" class="btn btn-danger btn-lg">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Go to Dislike Packages
                    </a>
                </div>

                <hr class="my-4">

                <div class="text-center mb-3">
                    <h6 class="text-muted">Or choose a package below:</h6>
                </div>

                <div class="row" id="giftDislikePackages">
                    <!-- Packages will be loaded here -->
                    <div class="col-12 text-center">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Like Success Modal -->
<div class="modal fade" id="likeSuccessModal" tabindex="-1" aria-labelledby="likeSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="likeSuccessModalLabel">
                    <i class="fas fa-heart"></i> Like Given!
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p>You have successfully given a like to {{ profile.user.get_full_name|default:profile.user.username }}!</p>
                <p class="text-muted">If this person also gives you a like, you'll get a match and can chat with each other.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
    // Show success modal if like was given (you can pass this from the view)
    {% if messages %}
        {% for message in messages %}
            {% if 'like' in message.tags %}
                var likeModal = new bootstrap.Modal(document.getElementById('likeSuccessModal'));
                likeModal.show();
            {% endif %}
        {% endfor %}
    {% endif %}

    // Load gift packages when modal opens
    document.getElementById('giftLikesModal').addEventListener('show.bs.modal', function () {
        fetch('/payments/api/packages/')
            .then(response => response.json())
            .then(data => {
                const packagesContainer = document.getElementById('giftPackages');
                packagesContainer.innerHTML = '';
                
                data.packages.forEach(package => {
                    const isPopular = package.name.toLowerCase().includes('populair') || package.name.toLowerCase().includes('popular');
                    
                    const packageHtml = `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 ${isPopular ? 'border-warning' : ''}">
                                <div class="card-header text-center ${isPopular ? 'bg-warning text-dark' : 'bg-primary text-white'}">
                                    <h6 class="mb-0">${package.name}</h6>
                                    ${isPopular ? '<small class="badge bg-dark">POPULAIR</small>' : ''}
                                </div>
                                <div class="card-body text-center">
                                    <div class="h4 text-primary mb-2">€${package.price}</div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block"><i class="fas fa-heart text-danger"></i> ${package.regular_likes} Regular Likes</small>
                                        ${package.super_likes > 0 ? `<small class="text-muted d-block"><i class="fas fa-star text-warning"></i> ${package.super_likes} Super Likes</small>` : ''}
                                        ${package.boosters > 0 ? `<small class="text-muted d-block"><i class="fas fa-rocket text-info"></i> ${package.boosters} Boosters</small>` : ''}
                                    </div>
                                    <button onclick="giftPackage(${package.id})" class="btn ${isPopular ? 'btn-warning' : 'btn-primary'} btn-sm w-100">
                                        <i class="fas fa-gift"></i> Gift Package
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    packagesContainer.innerHTML += packageHtml;
                });
            })
            .catch(error => {
                console.error('Error loading packages:', error);
                document.getElementById('giftPackages').innerHTML = 
                    '<div class="col-12 text-center"><div class="alert alert-danger">Error loading packages</div></div>';
            });
    });

    // Load gift dislike packages when modal opens
    document.getElementById('giftDislikesModal').addEventListener('show.bs.modal', function () {
        fetch('/payments/api/packages/')
            .then(response => response.json())
            .then(data => {
                const packagesContainer = document.getElementById('giftDislikePackages');
                packagesContainer.innerHTML = '';
                
                // Filter packages that have unlikes
                const dislikePackages = data.packages.filter(package => package.unlikes > 0);
                
                if (dislikePackages.length === 0) {
                    packagesContainer.innerHTML = '<div class="col-12 text-center"><div class="alert alert-info">No dislike packages available</div></div>';
                    return;
                }
                
                dislikePackages.forEach(package => {
                    const isPopular = package.name.toLowerCase().includes('populair') || package.name.toLowerCase().includes('popular');
                    
                    const packageHtml = `
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 ${isPopular ? 'border-danger' : ''}">
                                <div class="card-header text-center ${isPopular ? 'bg-danger text-white' : 'bg-dark text-white'}">
                                    <h6 class="mb-0">${package.name}</h6>
                                    ${isPopular ? '<small class="badge bg-light text-dark">POPULAIR</small>' : ''}
                                </div>
                                <div class="card-body text-center">
                                    <div class="h4 text-danger mb-2">€${package.price}</div>
                                    <div class="mb-3">
                                        ${package.unlikes > 0 ? `<small class="text-muted d-block"><i class="fas fa-times-circle text-danger"></i> ${package.unlikes} Dislikes</small>` : ''}
                                        ${package.regular_likes > 0 ? `<small class="text-muted d-block"><i class="fas fa-heart text-danger"></i> ${package.regular_likes} Regular Likes</small>` : ''}
                                        ${package.super_likes > 0 ? `<small class="text-muted d-block"><i class="fas fa-star text-warning"></i> ${package.super_likes} Super Likes</small>` : ''}
                                        ${package.boosters > 0 ? `<small class="text-muted d-block"><i class="fas fa-rocket text-info"></i> ${package.boosters} Boosters</small>` : ''}
                                    </div>
                                    <button onclick="giftPackage(${package.id})" class="btn ${isPopular ? 'btn-danger' : 'btn-dark'} btn-sm w-100">
                                        <i class="fas fa-gift"></i> Gift Package
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    packagesContainer.innerHTML += packageHtml;
                });
            })
            .catch(error => {
                console.error('Error loading dislike packages:', error);
                document.getElementById('giftDislikePackages').innerHTML = 
                    '<div class="col-12 text-center"><div class="alert alert-danger">Error loading packages</div></div>';
            });
    });

    // Handle gift package purchase
    function giftPackage(packageId) {
        const recipientId = {{ profile.user.id }};
        const recipientName = '{{ profile.user.first_name|default:profile.user.username }}';

        // Redirect to gift purchase page
        window.location.href = `/payments/gift/${packageId}/${recipientId}/`;
    }

    // Like amount controls
    function incrementAmount(type) {
        const input = document.getElementById(type + '_amount');
        const max = parseInt(input.getAttribute('max'));
        let currentValue = parseInt(input.value);
        
        if (currentValue < max) {
            input.value = currentValue + 1;
            if (type === 'like') {
                validateLikeAmount();
                updateLikeRangeFromAmount();
            } else {
                validateDislikeAmount();
                updateDislikeRangeFromAmount();
            }
        }
    }

    function decrementAmount(type) {
        const input = document.getElementById(type + '_amount');
        let currentValue = parseInt(input.value);
        
        if (currentValue > 1) {
            input.value = currentValue - 1;
            if (type === 'like') {
                validateLikeAmount();
                updateLikeRangeFromAmount();
            } else {
                validateDislikeAmount();
                updateDislikeRangeFromAmount();
            }
        }
    }

    function validateLikeAmount() {
        const input = document.getElementById('like_amount');
        const likeType = document.getElementById('like_type').value;
        const regularBalance = {{ user.likes_balance }};
        const superBalance = {{ user.super_likes_balance }};
        const maxBalance = likeType === 'super' ? superBalance : regularBalance;
        
        let amount = parseInt(input.value);
        if (amount > maxBalance) {
            amount = maxBalance;
            input.value = amount;
        }
        if (amount < 1) {
            amount = 1;
            input.value = amount;
        }
        
        document.getElementById('like_amount_display').textContent = amount;
        
        // Enable/disable submit button
        const submitBtn = document.getElementById('give_likes_btn');
        submitBtn.disabled = amount <= 0 || amount > maxBalance;
    }

    function validateDislikeAmount() {
        const input = document.getElementById('dislike_amount');
        const maxBalance = {{ user.unlikes_balance }};
        
        let amount = parseInt(input.value);
        if (amount > maxBalance) {
            amount = maxBalance;
            input.value = amount;
        }
        if (amount < 1) {
            amount = 1;
            input.value = amount;
        }
        
        document.getElementById('dislike_amount_display').textContent = amount;
        
        // Enable/disable submit button
        const submitBtn = document.getElementById('give_dislikes_btn');
        submitBtn.disabled = amount <= 0 || amount > maxBalance;
    }

    function updateLikeBalanceDisplay() {
        const likeType = document.getElementById('like_type').value;
        const regularBalance = {{ user.likes_balance }};
        const superBalance = {{ user.super_likes_balance }};
        const balance = likeType === 'super' ? superBalance : regularBalance;
        const typeName = likeType === 'super' ? 'super likes' : 'regular likes';
        
        document.getElementById('like_balance_text').textContent = `Available: ${balance} ${typeName}`;
        document.getElementById('like_amount').setAttribute('max', balance);
        document.getElementById('like_range').setAttribute('max', balance);
        document.getElementById('like_max_value').textContent = balance;
        
        // Reset amount to 1 and validate
        document.getElementById('like_amount').value = 1;
        document.getElementById('like_range').value = 1;
        validateLikeAmount();
    }

    function updateLikeAmountFromRange() {
        const range = document.getElementById('like_range');
        const input = document.getElementById('like_amount');
        input.value = range.value;
        validateLikeAmount();
    }

    function updateLikeRangeFromAmount() {
        const input = document.getElementById('like_amount');
        const range = document.getElementById('like_range');
        range.value = input.value;
    }

    function updateDislikeAmountFromRange() {
        const range = document.getElementById('dislike_range');
        const input = document.getElementById('dislike_amount');
        input.value = range.value;
        validateDislikeAmount();
    }

    function updateDislikeRangeFromAmount() {
        const input = document.getElementById('dislike_amount');
        const range = document.getElementById('dislike_range');
        range.value = input.value;
    }

    // Initialize controls when modals open
    document.getElementById('giveLikesModal').addEventListener('show.bs.modal', function () {
        updateLikeBalanceDisplay();
    });

    document.getElementById('giveDislikesModal').addEventListener('show.bs.modal', function () {
        validateDislikeAmount();
    });

    // Handle match request response from profile page
    function respondToMatchFromProfile(notificationId, action) {
        const formData = new FormData();
        formData.append('action', action);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(`/notifications/respond/${notificationId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // Insert after the match request alert
                const matchRequestAlert = document.querySelector('.alert-info');
                if (matchRequestAlert) {
                    matchRequestAlert.style.display = 'none';
                    matchRequestAlert.parentNode.insertBefore(alertDiv, matchRequestAlert.nextSibling);
                }

                // Redirect if it's a match
                if (data.redirect_url) {
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 2000);
                } else {
                    // Reload page after 2 seconds to update the UI
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
            }
        })
        .catch(error => console.error('Error responding to match:', error));
    }

    // Load advertisements on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAdvertisements();
    });

    function loadAdvertisements() {
        fetch('/advertisements/api/active/')
            .then(response => response.json())
            .then(data => {
                const slidesContainer = document.getElementById('advertisementSlides');
                const indicatorsContainer = document.getElementById('advertisementIndicators');
                
                if (data.advertisements.length === 0) {
                    slidesContainer.innerHTML = `
                        <div class="carousel-item active">
                            <div class="d-flex justify-content-center align-items-center advertisement-container">
                                <div class="text-center text-muted">
                                    <i class="fas fa-bullhorn fa-3x mb-3"></i>
                                    <p>No advertisements available</p>
                                </div>
                            </div>
                        </div>
                    `;
                    indicatorsContainer.innerHTML = '';
                    return;
                }

                let slidesHtml = '';
                let indicatorsHtml = '';

                data.advertisements.forEach((ad, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const clickAction = ad.brand_url ? `onclick="window.open('${ad.brand_url}', '_blank')"` : '';
                    const cursorStyle = ad.brand_url ? 'cursor: pointer;' : '';
                    
                    slidesHtml += `
                        <div class="carousel-item ${isActive}">
                            <div class="advertisement-slide" ${clickAction} style="${cursorStyle}">
                                <img src="${ad.flyer_image}" 
                                     alt="${ad.brand_name}" 
                                     class="d-block advertisement-image">
                                <div class="advertisement-overlay">
                                    <h6 class="advertisement-brand">${ad.brand_name}</h6>
                                    ${ad.brand_url ? '<small class="text-muted">Click to visit</small>' : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    indicatorsHtml += `
                        <button type="button" data-bs-target="#advertisementCarousel" 
                                data-bs-slide-to="${index}" 
                                ${isActive ? 'class="active" aria-current="true"' : ''}
                                aria-label="Ad ${index + 1}"></button>
                    `;
                });

                slidesContainer.innerHTML = slidesHtml;
                indicatorsContainer.innerHTML = indicatorsHtml;

                // Hide carousel controls if only one ad
                const carousel = document.getElementById('advertisementCarousel');
                if (data.advertisements.length <= 1) {
                    carousel.querySelector('.carousel-control-prev').style.display = 'none';
                    carousel.querySelector('.carousel-control-next').style.display = 'none';
                    indicatorsContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error loading advertisements:', error);
                document.getElementById('advertisementSlides').innerHTML = `
                    <div class="carousel-item active">
                        <div class="d-flex justify-content-center align-items-center advertisement-container">
                            <div class="text-center text-muted">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p>Error loading advertisements</p>
                            </div>
                        </div>
                    </div>
                `;
            });
    }
</script>

<style>
/* Advertisement slideshow styles */
.advertisement-container {
    height: 350px;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

.advertisement-slide {
    position: relative;
    transition: transform 0.3s ease;
    border-radius: 8px;
    overflow: hidden;
    height: 350px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.advertisement-slide:hover {
    transform: scale(1.02);
}

.advertisement-image {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    max-width: 250px;
    max-height: 330px;
    width: auto;
    height: auto;
    object-fit: contain;
}

.advertisement-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 20px 15px 10px;
    text-align: center;
}

.advertisement-brand {
    margin: 0;
    font-weight: 600;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
}

#advertisementCarousel .carousel-control-prev,
#advertisementCarousel .carousel-control-next {
    background: rgba(0,0,0,0.3);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    top: 50%;
    transform: translateY(-50%);
}

#advertisementCarousel .carousel-control-prev {
    left: 10px;
}

#advertisementCarousel .carousel-control-next {
    right: 10px;
}

#advertisementCarousel .carousel-indicators {
    bottom: -35px;
}

#advertisementCarousel .carousel-indicators button {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #007bff;
    border: none;
    margin: 0 3px;
}

.advertisement-slide[style*="cursor: pointer"] .advertisement-overlay::after {
    content: "🔗";
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 1.2em;
}

/* Responsive advertisement styles */
@media (max-width: 768px) {
    .advertisement-container {
        height: 300px;
    }
    
    .advertisement-slide {
        height: 300px;
    }
    
    .advertisement-image {
        max-width: 200px;
        max-height: 280px;
    }
    
    .advertisement-overlay {
        padding: 15px 10px 8px;
    }
    
    .advertisement-brand {
        font-size: 0.9rem;
    }
    
    #advertisementCarousel .carousel-control-prev,
    #advertisementCarousel .carousel-control-next {
        width: 35px;
        height: 35px;
    }
}

/* iPad specific improvements for profile detail */
@media (min-width: 768px) and (max-width: 1024px) {
    .container {
        padding: 0 20px;
    }
    
    /* Profile layout adjustments */
    .col-lg-4, .col-lg-8 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 30px;
    }
    
    /* Profile card improvements */
    .card-body {
        padding: 25px;
    }
    
    /* Carousel sizing for iPad */
    #profilePhotoCarousel {
        width: 200px !important;
        height: 200px !important;
        margin: 0 auto 20px;
    }
    
    .carousel-inner img {
        width: 200px !important;
        height: 200px !important;
    }
    
    /* Button improvements */
    .btn {
        min-height: 44px;
        padding: 12px 20px;
        font-size: 1rem;
    }
    
    .btn-sm {
        min-height: 40px;
        padding: 10px 16px;
        font-size: 0.9rem;
    }
    
    /* Modal improvements for iPad */
    .modal-dialog {
        margin: 40px auto;
        max-width: 90%;
    }
    
    .modal-content {
        border-radius: 15px;
    }
    
    /* Profile info layout */
    .card-title {
        font-size: 1.4rem;
        margin-bottom: 15px;
    }
    
    /* Statistics section */
    .nav-item .likes-balance {
        font-size: 1rem;
        padding: 8px 16px;
        display: block;
        text-align: center;
        margin: 10px 0;
    }
    
    /* Action buttons spacing */
    .d-grid .btn {
        margin-bottom: 12px;
    }
    
    /* Photo grid improvements */
    .row .col-md-4 {
        flex: 0 0 50%;
        max-width: 50%;
        margin-bottom: 20px;
    }
}

/* iPad Portrait specific */
@media (min-width: 768px) and (max-width: 834px) and (orientation: portrait) {
    .row .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
        margin-bottom: 20px;
    }
    
    /* Single column layout for better readability */
    .col-lg-4 {
        order: 1;
    }
    
    .col-lg-8 {
        order: 2;
    }
}

/* Touch-friendly improvements */
@media (pointer: coarse) {
    .carousel-control-prev,
    .carousel-control-next {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0,0,0,0.6);
    }
    
    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        width: 24px;
        height: 24px;
    }
    
    .carousel-indicators button {
        width: 12px;
        height: 12px;
        margin: 0 4px;
    }
    
    /* Form elements */
    input, select, textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        min-height: 44px;
    }
}
</style>
{% endblock %}